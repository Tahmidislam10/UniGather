<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Events</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
<header>
    <h1>UniGather</h1>
    <p>All events</p>

    <nav>
        <ul class="header-nav">
            <li><a href="/">Home</a></li>
            <li><a href="/about">About Us</a></li>
            <li><a href="/events-page" class="active">Events</a></li>
            <li><a href="/login">Login / Register</a></li>
        </ul>
    </nav>
</header>

<main>
    <section>
        <br />
        <!-- Staff-only button -->
        <a href="/create" class="button" id="create-event-btn">Create event</a>

        <br /><br />
        <form class="search-events">
            <input type="search" placeholder="Search for an event title..." />
            <button type="submit">Search</button>
        </form>
    </section>

    <!-- EVENTS RENDER HERE -->
    <section id="events-list"></section>
</main>

<footer>
    <h2>IN3046 Cloud Computing - Coursework Project</h2>
</footer>

<script>
    let allEvents = [];

    /* ======================
       FETCH EVENTS
    ====================== */
    async function getEvents() {
        try {
            const res = await fetch("/events");
            allEvents = await res.json();
            displayEvents(allEvents);
        } catch (err) {
            console.error("getEvents() error:", err);
            document.getElementById("events-list").innerHTML =
                "<p>Error loading events.</p>";
        }
    }

    /* ======================
       DISPLAY EVENTS
    ====================== */
    function displayEvents(events) {
        const eventsSection = document.getElementById("events-list");
        eventsSection.innerHTML = "";

        if (events.length === 0) {
            eventsSection.innerHTML = "<p>No events found.</p>";
            return;
        }

        for (const event of events) {
            const eventDiv = document.createElement("div");
            eventDiv.className = "event-item";

            eventDiv.innerHTML = `
                <div class="event-main">
                    <h3>${event.event_name}</h3>
                    <p>Host: ${event.host_name}</p>
                    <p>Click to toggle details...</p>
                    <span class="toggle-icon">â–¼</span>
                </div>

                <div class="event-details">
                    <p><strong>Email:</strong> ${event.host_email}</p>
                    <p><strong>Location:</strong> ${event.event_loc}</p>
                    <p><strong>Date:</strong> ${event.event_date}</p>
                    <p><strong>Time:</strong> ${event.event_time}</p>
                    <p><strong>Capacity:</strong> ${event.event_cap}</p>
                    <p><strong>Description:</strong> ${event.event_desc}</p>
                </div>
            `;

            eventDiv.onclick = () => toggleEvent(eventDiv);
            eventsSection.appendChild(eventDiv);
        }
    }

    function toggleEvent(eventDiv) {
        eventDiv.classList.toggle("toggled");
    }

    /* ======================
       AUTH HELPERS
    ====================== */
    function getCookie(name) {
        const match = document.cookie.match(
            new RegExp("(^| )" + name + "=([^;]+)")
        );
        return match ? decodeURIComponent(match[2]) : null;
    }

    function hideCreateIfNotStaff() {
        const role = getCookie("role");
        const btn = document.getElementById("create-event-btn");
        if (btn && role !== "staff") {
            btn.style.display = "none";
        }
    }

    hideCreateIfNotStaff();
    getEvents();
</script>
</body>
</html>
