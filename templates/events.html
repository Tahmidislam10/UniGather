<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Events</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/static/style.css" />
    </head>

    <body>
        <header>
            <h1>UniGather</h1>
            <p>All events</p>

            <nav>
                <ul class="header-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about">About Us</a></li>
                    <li><a href="/events-page" class="active">Events</a></li>
                    <li><a href="/login">Login / Register</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <section>
                <br />
                <a href="/create" class="button" id="create-event-button"
                    >Create event</a
                >

                <br /><br />
                <form class="search-events">
                    <input
                        type="search"
                        placeholder="Search for an event title..."
                    />
                    <button type="submit">Search</button>
                </form>
            </section>

            <!-- EVENTS RENDER HERE -->
            <section id="events-list"></section>
        </main>

        <footer>
            <h2>IN3046 Cloud Computing - Coursework Project</h2>
        </footer>

        <script>
            let allEvents = [];

            async function getEvents() {
                try {
                    const res = await fetch("/events");
                    allEvents = await res.json();
                    displayEvents(allEvents);
                } catch (err) {
                    console.error("getEvents() error: " + err);
                    document.getElementById("events-list").innerHTML =
                        "<p>Error loading events.</p>";
                }
            }

            function displayEvents(events) {
                const eventsSection = document.getElementById("events-list");
                eventsSection.innerHTML = "";

                if (events.length === 0) {
                    eventsSection.innerHTML = "<p>No events found.</p>";
                    return;
                }

                const currentUserId = getCookie("user_id");

                for (const event of events) {
                    console.log(event.booked_users);
                    const isBooked = event.booked_users && event.booked_users.includes(currentUserId);
                    const eventDiv = document.createElement("div");
                    eventDiv.className = "event-item";

                    eventDiv.innerHTML = `
                        <div class="event-main">
                            <h3>${event.event_name}</h3>
                            <p><b>Host:</b> ${event.host_name}</p>
                            <p><b>Date:</b> ${event.event_date}  <b>Time:</b> ${
                        event.event_time
                    }</p>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        
                        <div class="event-details">
                            <div class="event-details-wide">
                                <p><b>Full Event Title:</b> ${
                                    event.event_name
                                }</p>
                            </div>

                            <div class="event-details-grid">
                                <div>
                                    <p><b>Host Name:</b> ${event.host_name}</p>
                                    <p><b>Host Email:</b> ${
                                        event.host_email
                                    }</p>
                                    <p><b>Capacity:</b> ${event.event_cap}</p>
                                </div>

                                <div>
                                    <p><b>Date:</b> ${event.event_date}</p>
                                    <p><b>Time:</b> ${event.event_time}</p>
                                    <p><b>Location:</b> ${event.event_loc}</p>
                                </div>
                            </div>

                            <div class="event-details-wide">
                                <p><b>Description:</b></p>
                                <p style="white-space: pre-wrap">${
                                    event.event_desc
                                }</p>
                            </div>

                            <!-- DYNAMIC BOOK/CANCEL BUTTON -->
                            <button 
                                class="${isBooked ? "cancel-button" : "book-button"}"
                                onclick="${isBooked ? `cancelBooking('${event._id}')` : `makeBooking('${event._id}')`}; event.stopPropagation();">
                                ${isBooked ? "Cancel Booking" : "Book Event"}
                            </button>
                        </div>
                    `;

                    eventDiv.onclick = () => toggleEvent(eventDiv);
                    eventsSection.appendChild(eventDiv);
                }
            }

            function toggleEvent(event) {
                event.classList.toggle("toggled");
            }

            function getCookie(name) {
                const match = document.cookie.match(
                    new RegExp("(^| )" + name + "=([^;]+)")
                );
                return match ? decodeURIComponent(match[2]) : null;
            }

            function checkPermission(event) {
                const role = getCookie("role");

                if (role !== "staff") {
                    event.preventDefault();
                    alert("You must be logged in to create an event.");
                }
            }

            async function makeBooking(eventId) {
                try {
                    const res = await fetch("/book-event", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ eventId }),
                    });

                    alert(await res.text());
                    getEvents(); // Refreshes the events list
                } catch (err) {
                    console.error("Booking error:", err);
                    alert("Failed to book event");
                }
            }

            async function cancelBooking(eventId) {
                try {
                    const res = await fetch("/cancel-booking", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ eventId }),
                    });

                    alert(await res.text());
                    getEvents(); // Refreshes the events list
                } catch (err) {
                    console.error("Cancel error:", err);
                    alert("Failed to cancel booking");
                }
            }

            const createButton = document.getElementById("create-event-button");
            if (createButton)
                createButton.addEventListener("click", checkPermission);
            getEvents();
        </script>
    </body>
</html>
