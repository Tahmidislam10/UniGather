<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Events - UniGather</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/static/style.css" />
    </head>

    <body>
        <header>
            <div id="user-status" class="user-status" style="display: none;">
                <p>Welcome, <span id="display-username"></span></p>
                <a href="/logout" class="logout-link">Logout</a>
            </div>

            <h1>UniGather</h1>
            <p>All events</p>

            <nav>
                <ul class="header-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about">About Us</a></li>
                    <li><a href="/events-page" class="active">Events</a></li>
                    <li><a href="/login">Login / Register</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <section>
                <br />
                <a href="/create" class="button" id="create-event-button" style="display: none;"
                    >Create event</a
                >

                <br /><br />
                <form class="search-events">
                    <input
                        type="search"
                        placeholder="Search for an event title..."
                    />
                    <button type="submit">Search</button>
                </form>
            </section>

            <section id="events-list"></section>
        </main>

        <footer>
            <h2>IN3046 Cloud Computing - Coursework Project</h2>
        </footer>

<script>
    let allEvents = [];

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    document.addEventListener("DOMContentLoaded", function() {
        const username = getCookie("username");
        const role = getCookie("role");

        // UI Logic
        const userStatusDiv = document.getElementById("user-status");
        const displayUsername = document.getElementById("display-username");
        const loginNavItem = document.getElementById("nav-login");
        const createButton = document.getElementById("create-event-button");
        const adminNavItem = document.getElementById("nav-admin");

        if (username) {
            userStatusDiv.style.display = "block";
            displayUsername.innerText = decodeURIComponent(username);
            if (loginNavItem) loginNavItem.style.display = "none";
            if (role === "staff") {
                if (createButton) createButton.style.display = "inline-block";
                if (adminNavItem) adminNavItem.style.display = "block";
            }
        }
        
        getEvents(); // Initialize event list
    });

    async function getEvents() {
        try {
            const res = await fetch("/events");
            allEvents = await res.json();
            displayEvents(allEvents);
        } catch (err) {
            console.error("Fetch error:", err);
        }
    }

    function displayEvents(events) {
        const container = document.getElementById("events-list");
        container.innerHTML = "";
        events.forEach(event => {
            const div = document.createElement("div");
            div.className = "event-item";
            // Use event.id for DynamoDB compatibility
            div.innerHTML = `
                <div class="event-main">
                    <h3>${event.event_name}</h3>
                    <p>Host: ${event.host_name}</p>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="event-details" onclick="event.stopPropagation()">
                    <p>${event.event_desc}</p>
                    <button class="button" onclick="bookEvent('${event.id}')">Book</button>
                    <button class="button" onclick="cancelBooking('${event.id}')" style="background-color:#1e1e1e; color:white;">Cancel</button>
                </div>
            `;
            div.onclick = () => div.classList.toggle("toggled");
            container.appendChild(div);
        });
    }

    async function bookEvent(eventId) {
        const res = await fetch("/book-event", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ eventId })
        });
        alert(await res.text());
    }

    async function cancelBooking(eventId) {
        const res = await fetch("/cancel-booking", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ eventId })
        });
        alert(await res.text());
        getEvents();
    }
</script>
    </body>
</html>